<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Zoho Sales IQ Report Generator - Dark Mode</title>
  <style>
    :root {
      --background: #121217;
      --card-bg: #1e1e28;
      --text-primary: #e1e1e6;
      --text-secondary: #8b8baf;
      --accent-primary: #9068f3;
      --accent-secondary: #cfc5ff;
      --border-color: #292934;
      --table-header-bg: #2c2c3c;
      --table-row-hover: #2f2f41;
      --button-bg: linear-gradient(90deg,#9068f3 0%,#6c47ff 100%);
      --button-bg-hover: linear-gradient(90deg,#6c47ff 0%,#9068f3 100%);
    }
    html, body {
      margin: 0;
      padding: 0;
      background-color: var(--background);
      color: var(--text-primary);
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 48px 24px;
      font-size: 16px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .card {
      background-color: var(--card-bg);
      border-radius: 12px;
      max-width: 700px;
      width: 100%;
      padding: 32px 28px 36px;
      box-shadow: 0 4px 14px 0 rgb(100 81 255 / 0.2);
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 24px;
    }
    h1 {
      margin: 0;
      font-weight: 700;
      font-size: 2.5rem;
      color: var(--accent-primary);
      background: linear-gradient(90deg,var(--accent-primary) 0%,var(--accent-secondary) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-fill-color: transparent;
      user-select: none;
    }
    label {
      color: var(--text-secondary);
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 8px;
      user-select: none;
    }
    input[type="file"] {
      width: 100%;
      padding: 12px 14px;
      border-radius: 8px;
      outline: none;
      border: 1px solid var(--border-color);
      background-color: #2b2b39;
      color: var(--text-primary);
      font-size: 1rem;
      cursor: pointer;
      transition: border-color 0.2s;
    }
    input[type="file"]:focus {
      border-color: var(--accent-primary);
    }
    button {
      width: 100%;
      padding: 14px 0;
      border-radius: 10px;
      border: none;
      background: var(--button-bg);
      color: white;
      font-weight: 700;
      font-size: 1.1rem;
      letter-spacing: 0.04em;
      cursor: pointer;
      transition: background 0.3s ease;
      user-select: none;
    }
    button:hover {
      background: var(--button-bg-hover);
    }
    button:disabled {
      background: #555467;
      cursor: default;
      color: #b0afc6;
    }
    .report {
      margin-top: 32px;
      color: var(--text-primary);
      user-select: text;
    }
    .report-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 16px;
      border-bottom: 2px solid var(--accent-primary);
      padding-bottom: 8px;
    }
    table {
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
      border-radius: 10px;
      overflow: hidden;
      background-color: #242436;
      box-shadow: 0 0 0 1px var(--border-color);
      font-size: 0.95rem;
    }
    th, td {
      padding: 14px 18px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
      color: var(--text-primary);
    }
    th {
      background-color: var(--table-header-bg);
      font-weight: 700;
      color: var(--text-secondary);
      user-select: none;
    }
    tbody tr:hover {
      background-color: var(--table-row-hover);
    }
    @media (max-width: 700px) {
      .card {
        padding: 24px 20px;
      }
      h1 {
        font-size: 2rem;
      }
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Zoho Sales IQ Report Generator</h1>
    <label for="fileInput">Upload Excel or CSV file</label>
    <input type="file" id="fileInput" accept=".xls,.xlsx,.csv" />
    <button id="generateBtn" disabled>Generate Report</button>
    <div class="report" id="reportContainer"></div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    const fileInput = document.getElementById('fileInput');
    const generateBtn = document.getElementById('generateBtn');
    const reportContainer = document.getElementById('reportContainer');

    fileInput.addEventListener('change', () => {
      generateBtn.disabled = !fileInput.files.length;
      reportContainer.innerHTML = '';
    });

    generateBtn.addEventListener('click', async () => {
      if (!fileInput.files.length) return;
      const data = await readFile(fileInput.files[0]);
      const {headers, rows} = getProcessedData(data);
      const reportHtml = generateReport(headers, rows);
      reportContainer.innerHTML = reportHtml;
    });

    function readFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const uint8Array = new Uint8Array(e.target.result);
            const workbook = XLSX.read(uint8Array, {type: 'array'});
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            const data = XLSX.utils.sheet_to_json(worksheet, {header: 1});
            resolve(data);
          } catch (err) {
            reject(err);
          }
        };
        reader.readAsArrayBuffer(file);
      });
    }

    function findHeaderRow(data) {
      for (let i = 0; i < data.length; i++) {
        const row = data[i] || [];
        const filled = row.filter(cell => cell && cell.toString().trim() !== '').length;
        if (
          filled === 0 ||
          (filled === 1 && (row[0] || '').toString().trim().toLowerCase() === 'history')
        ) continue;
        return i;
      }
      return 0;
    }

    function getProcessedData(data) {
      const headerRowIndex = findHeaderRow(data);
      const headers = (data[headerRowIndex] || []).map(h => h ? h.toString().toLowerCase() : '');
      const rows = data.slice(headerRowIndex + 1);
      return {headers, rows};
    }

    function parseCustomerInfo(cell) {
      try {
        if (!cell || typeof cell !== 'string') return 'Other';
        const obj = JSON.parse(cell);
        if (typeof obj === 'object') {
          return obj['visit.q1'] || 'Other';
        }
        return 'Other';
      } catch (e) {
        return 'Other';
      }
    }

    function hmsToSeconds(str) {
      if (!str) return 0;
      const parts = str.split(':').map(Number);
      while (parts.length < 3) parts.unshift(0);
      const [hours, minutes, seconds] = parts;
      return hours * 3600 + minutes * 60 + seconds;
    }

    function formatDuration(sec) {
      sec = Math.round(sec);
      if (isNaN(sec)) return 'N/A';
      const h = Math.floor(sec / 3600);
      const m = Math.floor((sec % 3600) / 60);
      const s = sec % 60;
      return (h > 0 ? `${h}h ` : '') + (m > 0 ? `${m}m ` : '') + `${s}s`;
    }

    function sortByCount(obj) {
      return Object.entries(obj).sort((a, b) => b[1] - a[1]);
    }

    function generateReport(headers, rows) {
      if (!headers.length || !rows.length) return '<p>No data to analyze.</p>';

      const getColIdx = keyword => headers.findIndex(h => h.includes(keyword));
      const customerCol = getColIdx('customer info');
      const embedCol = getColIdx('embed');
      const countryCol = getColIdx('country');
      const durationHMSCol = getColIdx('chat duration(in secs)');
      const avgResponseTimeHMSCol = getColIdx('average response time(in secs)');
      const firstAgentRespTimeHMSCol = getColIdx('first agent first response time(in secs)');
      const visitorMsgCountCol = getColIdx('visitor message count');
      const operatorMsgCountCol = getColIdx('operator message count');

      const subjectsList = ['Bonus/Free Spins', 'Withdrawal', 'Account', 'Deposit', 'Game Issue', 'Verification'];
      const customerBreakdown = {};
      subjectsList.forEach(s => (customerBreakdown[s] = 0));
      let customerOther = 0,
        totalChats = 0;
      rows.forEach(row => {
        const cell = customerCol !== -1 ? row[customerCol] : '';
        const subject = parseCustomerInfo(cell);
        if (subjectsList.includes(subject)) customerBreakdown[subject]++;
        else customerOther++;
        totalChats++;
      });
      customerBreakdown['Other'] = customerOther;
      const sortedSubjects = sortByCount(customerBreakdown);

      const brandsCount = {};
      rows.forEach(row => {
        const val = embedCol !== -1 && row[embedCol] ? row[embedCol].trim() : 'Unknown';
        brandsCount[val] = (brandsCount[val] || 0) + 1;
      });
      const sortedBrands = sortByCount(brandsCount);
      const totalBrands = Object.values(brandsCount).reduce((a, b) => a + b, 0);

      const countriesCount = {};
      rows.forEach(row => {
        const val = countryCol !== -1 && row[countryCol] ? row[countryCol].trim() : 'Unknown';
        countriesCount[val] = (countriesCount[val] || 0) + 1;
      });
      const sortedCountries = sortByCount(countriesCount);
      const totalCountries = Object.values(countriesCount).reduce((a, b) => a + b, 0);

      function filteredByMinPct(array, total) {
        return array.filter(([_, count]) => (count / (total || 1)) * 100 >= 0.5);
      }

      const avgChatDuration = (() => {
        if (durationHMSCol === -1) return 'N/A';
        let sum = 0,
          count = 0;
        rows.forEach(r => {
          const sec = hmsToSeconds(r[durationHMSCol]);
          if (!isNaN(sec) && sec > 0) {
            sum += sec;
            count++;
          }
        });
        return count ? formatDuration(sum / count) : 'N/A';
      })();
      const avgResponseTime = (() => {
        if (avgResponseTimeHMSCol === -1) return 'N/A';
        let sum = 0,
          count = 0;
        rows.forEach(r => {
          const sec = hmsToSeconds(r[avgResponseTimeHMSCol]);
          if (!isNaN(sec) && sec > 0) {
            sum += sec;
            count++;
          }
        });
        return count ? formatDuration(sum / count) : 'N/A';
      })();
      const avgFirstAgentRespTime = (() => {
        if (firstAgentRespTimeHMSCol === -1) return 'N/A';
        let sum = 0,
          count = 0;
        rows.forEach(r => {
          const sec = hmsToSeconds(r[firstAgentRespTimeHMSCol]);
          if (!isNaN(sec) && sec > 0) {
            sum += sec;
            count++;
          }
        });
        return count ? formatDuration(sum / count) : 'N/A';
      })();
      function avgCountCol(colIdx) {
        if (colIdx === -1) return 'N/A';
        let sum = 0,
          cnt = 0;
        rows.forEach(r => {
          const v = parseFloat(r[colIdx]);
          if (!isNaN(v)) {
            sum += v;
            cnt++;
          }
        });
        return cnt ? (sum / cnt).toFixed(2) : 'N/A';
      }
      const avgVisitorMsgCount = avgCountCol(visitorMsgCountCol);
      const avgOperatorMsgCount = avgCountCol(operatorMsgCountCol);

      let html = `
        <div class="report-title">üìã Customer Info Breakdown</div>
        <table>
          <thead>
            <tr>
              <th>Subject</th>
              <th>Chats</th>
              <th>Percentage</th>
            </tr>
          </thead>
          <tbody>`;
      filteredByMinPct(sortedSubjects, totalChats).forEach(([key, val]) => {
        const perc = totalChats ? ((val / totalChats) * 100).toFixed(1) : '0.0';
        html += `<tr><td>${key}</td><td>${val}</td><td>${perc}%</td></tr>`;
      });
      html += `</tbody></table>`;

      html += `
        <div class="report-title">üè¢ Brands Breakdown</div>
        <table>
          <thead>
            <tr>
              <th>Brand</th>
              <th>Chats</th>
              <th>Percentage</th>
            </tr>
          </thead>
          <tbody>`;
      filteredByMinPct(sortedBrands, totalBrands).forEach(([brand, count]) => {
        const perc = totalBrands ? ((count / totalBrands) * 100).toFixed(1) : '0.0';
        html += `<tr><td>${brand}</td><td>${count}</td><td>${perc}%</td></tr>`;
      });
      html += `</tbody></table>`;

      html += `
        <div class="report-title">üåç Countries Breakdown</div>
        <table>
          <thead>
            <tr>
              <th>Country</th>
              <th>Chats</th>
              <th>Percentage</th>
            </tr>
          </thead>
          <tbody>`;
      filteredByMinPct(sortedCountries, totalCountries).forEach(([country, count]) => {
        const perc = totalCountries ? ((count / totalCountries) * 100).toFixed(1) : '0.0';
        html += `<tr><td>${country}</td><td>${count}</td><td>${perc}%</td></tr>`;
      });
      html += `</tbody></table>`;

      html += `
        <div class="report-title">‚è±Ô∏è Performance Metrics</div>
        <table>
          <tbody>
            <tr><th>Metric</th><th>Average</th></tr>
            <tr><td>Chat Duration</td><td>${avgChatDuration}</td></tr>
            <tr><td>Response Time</td><td>${avgResponseTime}</td></tr>
            <tr><td>First Agent Response Time</td><td>${avgFirstAgentRespTime}</td></tr>
            <tr><td>Visitor Messages</td><td>${avgVisitorMsgCount}</td></tr>
            <tr><td>Operator Messages</td><td>${avgOperatorMsgCount}</td></tr>
          </tbody>
        </table>`;

      return html;
    }
  </script>
</body>
</html>
